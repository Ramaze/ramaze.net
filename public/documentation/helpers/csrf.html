
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>CSRF Helper &mdash; Ramaze v2011.01.30 documentation</title>
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2011.01.30',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Ramaze v2011.01.30 documentation" href="../index.html" />
    <link rel="up" title="Helpers" href="introduction.html" />
    <link rel="next" title="Blueform Helper" href="blueform.html" />
    <link rel="prev" title="Helpers" href="introduction.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="blueform.html" title="Blueform Helper"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="introduction.html" title="Helpers"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Ramaze v2011.01.30 documentation</a> &raquo;</li>
          <li><a href="introduction.html" accesskey="U">Helpers</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="csrf-helper">
<h1>CSRF Helper<a class="headerlink" href="#csrf-helper" title="Permalink to this headline">¶</a></h1>
<p>The CSRF helper can be used to protect your applications from
<abbr title="Cross Site Request Forgery">CSRF</abbr> attacks. Because these attacks can be executed
in a few different ways I highly recommend reading the <a class="reference external" href="http://en.wikipedia.org/wiki/Cross-site_request_forgery/">Wikipedia</a> article about these
attacks.</p>
<p>The important thing to remember is that you&#8217;ll <em>almost</em> always want to use the CSRF
helper when you&#8217;re using some sort of authentication system that grants users access to
dangerous actions such as deleting data from a database. This helper may not be 100%
bulletproof but it will save you a lot of trouble.</p>
<div class="section" id="using-the-helper">
<h2>Using the Helper<a class="headerlink" href="#using-the-helper" title="Permalink to this headline">¶</a></h2>
<p>As with any other helper you&#8217;ll first need to load it in your controller(s):</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Posts</span> <span class="o">&lt;</span> <span class="no">Ramaze</span><span class="o">::</span><span class="no">Controller</span>
  <span class="n">map</span> <span class="s1">&#39;/posts&#39;</span>

  <span class="n">helper</span> <span class="ss">:csrf</span>

  <span class="k">def</span> <span class="nf">dangerous</span>

  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Now that the helper is loaded the fun can begin. In order to use the helper we&#8217;ll have to
add a &#8220;before_all&#8221; call to our controller:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Posts</span> <span class="o">&lt;</span> <span class="no">Ramaze</span><span class="o">::</span><span class="no">Controller</span>
  <span class="n">map</span> <span class="s1">&#39;/posts&#39;</span>

  <span class="n">helper</span> <span class="ss">:csrf</span>

  <span class="n">before_all</span> <span class="k">do</span>

  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">dangerous</span>

  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">You should <strong>not</strong> use an after_all call in your controller as by the time this block is
called the request has already been executed.</p>
</div>
<p>This block is called every time a request is made and is executed <em>before</em> the actual
method is executed. This makes it easy to validate the request before executing any
dangerous actions. In order to protect the controller from CSRF attacks we need to add a
call to the method &#8220;csrf_protection&#8221; in the before_all block:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Posts</span> <span class="o">&lt;</span> <span class="no">Ramaze</span><span class="o">::</span><span class="no">Controller</span>
  <span class="n">map</span> <span class="s1">&#39;/posts&#39;</span>

  <span class="n">helper</span> <span class="ss">:csrf</span>

  <span class="n">before_all</span> <span class="k">do</span>
    <span class="n">csrf_protection</span><span class="p">(</span><span class="ss">:dangerous</span><span class="p">)</span> <span class="k">do</span>

    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">dangerous</span>

  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>You might&#8217;ve noticed that the argument of the csrf_protection method matches the name of
the method &#8220;dangerous&#8221;. The arguments sent to the csrf_protection should be the names of
the methods you wish to protect against CSRF attacks. Each method is sent as an extra
parameter to this method.</p>
<p>The content inside the block we&#8217;ve just added will <em>only</em> be executed if the request was
invalid. Say we want to abort the request and show an error we&#8217;d do the following:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Posts</span> <span class="o">&lt;</span> <span class="no">Ramaze</span><span class="o">::</span><span class="no">Controller</span>
  <span class="n">map</span> <span class="s1">&#39;/posts&#39;</span>

  <span class="n">helper</span> <span class="ss">:csrf</span>

  <span class="n">before_all</span> <span class="k">do</span>
    <span class="n">csrf_protection</span><span class="p">(</span><span class="ss">:dangerous</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">respond</span><span class="p">(</span><span class="s2">&quot;The request was invalid&quot;</span><span class="p">,</span> <span class="mi">401</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">dangerous</span>

  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="setting-tokens">
<h2>Setting Tokens<a class="headerlink" href="#setting-tokens" title="Permalink to this headline">¶</a></h2>
<p>Once a method is protected against CSRF attacks using this helper it will require a
special token to be set for all requests (GET, POST, all of them). This token can either
be set as a query string parameter or as a POST parameter. To make your life easier the
helper provides the method &#8220;get_csrf_token&#8221;. This method generates a new token if the
client doesn&#8217;t have one yet or use the existing one. You&#8217;d normally use this method as
following:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">action=</span><span class="s">&quot;#{Posts.r(:dangerous)}&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name=</span><span class="s">&quot;csrf_token&quot;</span> <span class="na">value=</span><span class="s">&quot;#{get_csrf_token}&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
<p>Now whenever this form is submitted the token will be sent to the server and everything
should work just fine.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It&#8217;s currently not yet possible to change the field name (&#8220;csrf_token&#8221;) to something
else. Feel free to add a patch to make this possible (hint: use traits).</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The CSRF helper checks the IP address, hostname and user agent of the client that sent
the request to the server. This means that if a user has a form opened and switches to
a different IP the token will be invalid.</p>
</div>
<p>If you&#8217;re protecting a method that requires a GET request you&#8217;ll have to set the token
as a query string parameter:</p>
<div class="highlight-python"><pre>http://ramaze.net?csrf_token=XXXXXXX</pre>
</div>
<p>And that&#8217;s really about it. The helper is fairly easy to use and should be able to protect
your applications from most CSRF attacks.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">CSRF Helper</a><ul>
<li><a class="reference internal" href="#using-the-helper">Using the Helper</a></li>
<li><a class="reference internal" href="#setting-tokens">Setting Tokens</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="introduction.html"
                        title="previous chapter">Helpers</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="blueform.html"
                        title="next chapter">Blueform Helper</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/helpers/csrf.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="blueform.html" title="Blueform Helper"
             >next</a></li>
        <li class="right" >
          <a href="introduction.html" title="Helpers"
             >previous</a> |</li>
        <li><a href="../index.html">Ramaze v2011.01.30 documentation</a> &raquo;</li>
          <li><a href="introduction.html" >Helpers</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Michael Fellinger, Yorick Peterse.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>