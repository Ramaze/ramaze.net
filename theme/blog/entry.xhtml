<?r
entry = get_entry(@request_uri[2], :categories => true)

show_404 if !entry

if entry.section.comment_allow == true
  comments = get_comments(@request_uri[2]).all
end
?>
<!DOCTYPE html>
<html lang="#{get_setting(:language).value}">
    <head>
        #{partial(:head)}
    </head>
    <body>
        <div class="container">
            <div id="container" class="row">
                <div id="top" class="grid_12">
                    #{partial(:header)}
                </div>

                <div id="content" class="grid_12">
                        <article>
                            <header>
                                <h1>
                                    #{entry.title}
                                </h1>
                                <p class="meta">
                                    Written by #{entry.user.name} on
                                    <time pubdate="pubdate"
                                    datetime="#{entry.created_at.strftime('%Y-%m-%d')}">
                                        #{entry.created_at.strftime('%A, %B %d, %Y')}
                                    </time>
                                </p>
                            </header>

                            #{entry.fields[:body]}

                            <footer>
                                <p>
                                    Posted in:
                                    #{entry.categories.map { |c| c.name }.join(', ') }

                                    <?r if entry.section.comment_allow == true ?>
                                    |
                                    <?r if comments.length === 1 ?>

                                    1 comment

                                    <?r else ?>

                                    #{comments.length} comments

                                    <?r end ?>

                                    <?r end ?>
                                </p>
                            </footer>
                        </article>
                    </section>

                    <!-- Comments, yay -->
                    <?r if entry.section.comment_allow == true ?>
                    <section id="comments">
                        <h1>Comments</h1>

                        <?r if comments.length == 0 ?>

                        <p>No comments have been posted yet.</p>

                        <?r else; comments.each do |comment| ?>

                        <article>
                            <header>
                                <h1>
                                    <a href="#{comment.website}">
                                        #{comment.name}
                                    </a>
                                </h1>

                                <p class="meta">
                                    <time pubdate="pubdate"
                                    datetime="#{comment.created_at.strftime('%Y-%m-%d')}">
                                        #{comment.created_at.strftime('%A, %B %d, %Y')}
                                    </time>
                                </p>
                            </header>

                            <p>#{comment.comment}</p>
                        </article>

                        <?r end; end ?>
                    </section>

                    #{partial(:comments_form, :section_entry => entry.id)}
                    <?r end ?>
                </div>
            </div>

            #{partial(:footer)}
        </div>
    </body>
</html>
